<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auction & Chat WebSocket Tester</title>
    <!-- SockJS + STOMP (from CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        fieldset { margin-bottom: 20px; }
        legend { font-weight: bold; }
        label { display: inline-block; width: 130px; }
        input[type="text"], input[type="number"] { width: 300px; }
        textarea { width: 100%; height: 150px; margin-top: 10px; }
        button { margin-top: 5px; margin-right: 5px; }
        #status { font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<h2>Auction & Chat WebSocket Tester (STOMP)</h2>

<div id="status">Status: DISCONNECTED</div>

<!-- Connection Section -->
<fieldset>
    <legend>1. Connect</legend>
    <div>
        <label>WS Endpoint:</label>
        <input type="text" id="wsUrl" value="http://localhost:8087/ws-auction">
        <span>(SockJS URL)</span>
    </div>
    <!-- ðŸ”¥ removed JWT token field completely -->
    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
</fieldset>

<!-- Subscription Section -->
<fieldset>
    <legend>2. Subscribe</legend>
    <div>
        <label>Auction ID:</label>
        <input type="number" id="auctionId" value="1">
        <button onclick="subscribeAuction()">Subscribe Auction</button>
    </div>
    <div>
        <label>Request ID (Chat):</label>
        <input type="number" id="requestId" value="6">
        <button onclick="subscribeChat()">Subscribe Chat</button>
    </div>
</fieldset>

<!-- User ID -->
<fieldset>
    <legend>3. User Info</legend>
    <div>
        <label>User ID:</label>
        <!-- put some test userId (e.g. existing buyer userId like 10005) -->
        <input type="number" id="userId" value="10005">
        <span>(this will be sent in bid/chat payload)</span>
    </div>
</fieldset>

<!-- Send BID -->
<fieldset>
    <legend>4. Send Bid</legend>
    <div>
        <label>Bid Amount:</label>
        <input type="number" id="bidAmount" value="11000">
    </div>
    <button onclick="sendBid()">Send Bid</button>
</fieldset>

<!-- Send CHAT -->
<fieldset>
    <legend>5. Send Chat Message</legend>
    <div>
        <label>Chat Message:</label>
        <input type="text" id="chatMessage" value="Hello, I'm interested!">
    </div>
    <button onclick="sendChat()">Send Chat</button>
</fieldset>

<!-- Log Output -->
<fieldset>
    <legend>Logs</legend>
    <textarea id="log" readonly></textarea>
    <button onclick="clearLog()">Clear Log</button>
</fieldset>

<script>
    let stompClient = null;
    let connected = false;

    function log(message) {
        const logArea = document.getElementById('log');
        logArea.value += message + "\n";
        logArea.scrollTop = logArea.scrollHeight;
        console.log(message);
    }

    function setStatus(text) {
        document.getElementById('status').innerText = 'Status: ' + text;
    }

    function connect() {
        const baseUrl = document.getElementById('wsUrl').value.trim();

        if (!baseUrl) {
            alert('Please enter WebSocket URL');
            return;
        }

        // ðŸ”¥ No token, just plain SockJS URL
        const fullUrl = baseUrl;

        log('Connecting to: ' + fullUrl);

        const socket = new SockJS(fullUrl);
        stompClient = Stomp.over(socket);

        // Optional: disable debug logs
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            connected = true;
            setStatus('CONNECTED');
            log('Connected: ' + frame);
        }, function (error) {
            connected = false;
            setStatus('ERROR');
            log('Error: ' + error);
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(function () {
                setStatus('DISCONNECTED');
                log('Disconnected');
            });
        }
        connected = false;
    }

    function subscribeAuction() {
        if (!connected) {
            alert('Connect first');
            return;
        }
        const auctionId = document.getElementById('auctionId').value;
        const destination = '/topic/auction/' + auctionId;

        log('Subscribing to: ' + destination);

        stompClient.subscribe(destination, function (message) {
            log('[AUCTION ' + auctionId + '] ' + message.body);
        });
    }

    function subscribeChat() {
        if (!connected) {
            alert('Connect first');
            return;
        }
        const requestId = document.getElementById('requestId').value;
        const destination = '/topic/chat/' + requestId;

        log('Subscribing to: ' + destination);

        stompClient.subscribe(destination, function (message) {
            log('[CHAT ' + requestId + '] ' + message.body);
        });
    }

    function sendBid() {
        if (!connected) {
            alert('Connect first');
            return;
        }
        const auctionId = document.getElementById('auctionId').value;
        const bidAmount = document.getElementById('bidAmount').value;
        const userId = document.getElementById('userId').value;

        const destination = '/app/auction/' + auctionId + '/bid';
        const payload = {
            userId: Number(userId),      // ðŸ”¥ send userId
            auctionId: Number(auctionId),
            bidAmount: Number(bidAmount)
        };

        log('Sending BID to ' + destination + ': ' + JSON.stringify(payload));
        stompClient.send(destination, {}, JSON.stringify(payload));
    }

    function sendChat() {
        if (!connected) {
            alert('Connect first');
            return;
        }
        const requestId = document.getElementById('requestId').value;
        const message = document.getElementById('chatMessage').value;
        const userId = document.getElementById('userId').value;

        const destination = '/app/chat/' + requestId + '/send';
        const payload = {
            userId: Number(userId),      // ðŸ”¥ send userId
            message: message
        };

        log('Sending CHAT to ' + destination + ': ' + JSON.stringify(payload));
        stompClient.send(destination, {}, JSON.stringify(payload));
    }

    function clearLog() {
        document.getElementById('log').value = '';
    }
</script>

</body>
</html>
