<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Auction & Chat WebSocket Tester</title>

    <!-- SockJS + STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body { font-family: Arial; margin: 20px; }
        fieldset { margin-bottom: 20px; padding: 10px; }
        legend { font-weight: bold; }
        textarea { width: 100%; height: 200px; margin-top: 10px; }
        button { margin-top: 5px; margin-right: 5px; }
        #status { margin-bottom: 10px; font-size: 18px; font-weight: bold; }
    </style>
</head>

<body>

<h2>Auction & Chat WebSocket Tester (STOMP)</h2>

<div id="status">Status: DISCONNECTED</div>

<!-- WS Connect -->
<fieldset>
    <legend>1. Connect</legend>
    <label>WS Endpoint:</label>
    <input type="text" id="wsUrl" value="http://localhost:8087/ws-auction">
    <button onclick="connectWS()">Connect</button>
    <button onclick="disconnectWS()">Disconnect</button>
</fieldset>

<!-- Subscription -->
<fieldset>
    <legend>2. Subscribe</legend>
    <label>Auction ID:</label>
    <input type="number" id="auctionId" value="1">
    <button onclick="subscribeAuction()">Subscribe Auction</button>
    <br><br>
    <label>Request ID:</label>
    <input type="number" id="requestId" value="6">
    <button onclick="subscribeChat()">Subscribe Chat</button>
</fieldset>

<!-- User -->
<fieldset>
    <legend>3. User Info</legend>
    <label>User ID:</label>
    <input type="number" id="userId" value="10005">
</fieldset>

<!-- BID -->
<fieldset>
    <legend>4. Send Bid</legend>
    <label>Bid Amount:</label>
    <input type="number" id="bidAmount" value="11000">
    <button onclick="sendBid()">Send Bid</button>
</fieldset>

<!-- CHAT -->
<fieldset>
    <legend>5. Send Chat</legend>
    <label>Chat Message:</label>
    <input type="text" id="chatMessage" value="Hello, I'm interested!">
    <button onclick="sendChat()">Send</button>
</fieldset>

<!-- Logs -->
<fieldset>
    <legend>Logs</legend>
    <textarea id="log" readonly></textarea>
    <button onclick="clearLog()">Clear Log</button>
</fieldset>

<script>

    let stompClient = null;
    let connected = false;

    function log(msg) {
        const logBox = document.getElementById("log");
        logBox.value += msg + "\n";
        logBox.scrollTop = logBox.scrollHeight;
        console.log("LOG:", msg);
    }

    function setStatus(s) {
        document.getElementById("status").innerText = "Status: " + s;
    }

    function connectWS() {
        const url = document.getElementById("wsUrl").value.trim();
        log("Connecting to: " + url);

        const socket = new SockJS(url);
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // remove internal logs

        stompClient.connect({}, frame => {
            connected = true;
            setStatus("CONNECTED");
            log("Connected: " + frame);
        }, err => {
            setStatus("ERROR");
            log("Connection Error: " + err);
        });
    }

    function disconnectWS() {
        if (stompClient) {
            stompClient.disconnect(() => {
                setStatus("DISCONNECTED");
                log("Disconnected");
            });
        }
        connected = false;
    }

    function subscribeAuction() {
        if (!connected) return alert("Connect first!");

        const auctionId = document.getElementById("auctionId").value;
        const topic = `/topic/auction/${auctionId}`;

        log("Subscribing: " + topic);

        stompClient.subscribe(topic, message => {
            log(`[AUCTION ${auctionId}] ${message.body}`);
        });
    }

    function subscribeChat() {
        if (!connected) return alert("Connect first!");

        const requestId = document.getElementById("requestId").value;
        const topic = `/topic/chat/${requestId}`;

        log("Subscribing: " + topic);

        stompClient.subscribe(topic, message => {
            log(`[CHAT ${requestId}] ${message.body}`);
        });
    }

    function sendBid() {
        if (!connected) return alert("Connect first!");

        const auctionId = document.getElementById("auctionId").value;
        const userId = document.getElementById("userId").value;
        const bidAmount = document.getElementById("bidAmount").value;

        const destination = `/app/auction/${auctionId}/bid`;

        const body = {
            userId: Number(userId),
            auctionId: Number(auctionId),
            bidAmount: Number(bidAmount)
        };

        log("Sending BID → " + destination);
        log("Payload: " + JSON.stringify(body));

        stompClient.send(destination, {}, JSON.stringify(body));
    }

    function sendChat() {
        if (!connected) return alert("Connect first!");

        const requestId = document.getElementById("requestId").value;
        const userId = document.getElementById("userId").value;
        const msg = document.getElementById("chatMessage").value;

        const destination = `/app/chat/${requestId}/send`;

        const body = {
            userId: Number(userId),
            message: msg
        };

        log("Sending CHAT → " + destination);
        log("Payload: " + JSON.stringify(body));

        stompClient.send(destination, {}, JSON.stringify(body));
    }

    function clearLog() {
        document.getElementById("log").value = "";
    }

</script>

</body>
</html>
