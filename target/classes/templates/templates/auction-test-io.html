<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Laptop Auction - Live Socket.IO UI</title>

    <!-- SOCKET.IO CLIENT -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        body { font-family: Arial; margin: 20px; background: #f2f2f2; }
        fieldset { margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; }
        textarea { width: 100%; height: 180px; }
        .auction-card { padding: 10px; background: white; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 10px; }
        .live { color: green; font-weight: bold; }
        .ended { color: red; font-weight: bold; }
        button { padding: 6px 12px; }
    </style>
</head>

<body>

<h2>üíª Laptop LIVE Auction Dashboard (Socket.IO)</h2>

<div id="status">Status: DISCONNECTED</div>

<fieldset>
    <div>
        <label>Socket.IO Server URL:</label>
        <input type="text" id="wsUrl" value="http://localhost:3000">
    </div>

    <button onclick="connect()">Connect</button>
    <button onclick="disconnect()">Disconnect</button>
</fieldset>

<fieldset>
    <legend>LIVE Auctions</legend>
    <button onclick="subscribeLiveAuctions()">Start Listening</button>

    <div id="liveAuctionsContainer" style="margin-top:10px;">
        <i>No live auctions yet...</i>
    </div>
</fieldset>

<fieldset>
    <legend>Subscribe to an Auction</legend>
    Auction ID:
    <input type="number" id="auctionId" value="1">
    <button onclick="subscribeAuction()">Subscribe</button>
</fieldset>

<fieldset>
    <legend>Place a Bid</legend>
    User ID:
    <input type="number" id="userId" value="10005"><br><br>

    Bid Amount:
    <input type="number" id="bidAmount" value="20000">
    <button onclick="sendBid()">Send Bid</button>
</fieldset>

<fieldset>
    <legend>Chat System</legend>
    Request ID:
    <input type="number" id="requestId" value="3">
    <button onclick="subscribeChat()">Subscribe Chat</button><br><br>

    Message:
    <input type="text" id="chatMessage" value="Hello!" style="width:300px;">
    <button onclick="sendChat()">Send</button>
</fieldset>

<fieldset>
    <legend>Logs</legend>
    <textarea id="log" readonly></textarea>
</fieldset>


<script>

    let socket = null;
    let liveAuctions = {};

    function log(msg) {
        const area = document.getElementById("log");
        area.value += msg + "\n";
        area.scrollTop = area.scrollHeight;
        console.log(msg);
    }

    function setStatus(msg) {
        document.getElementById("status").innerText = "Status: " + msg;
    }

    // CONNECT --------------------------------------------------------------
    function connect() {
        const url = document.getElementById("wsUrl").value.trim();

        log("Connecting to Socket.IO server: " + url);

        socket = io(url, {
            transports: ["websocket"],
            reconnection: true
        });

        socket.on("connect", () => {
            setStatus("CONNECTED");
            log("üü¢ Connected: " + socket.id);
        });

        socket.on("disconnect", () => {
            setStatus("DISCONNECTED");
            log("üî¥ Disconnected");
        });

        socket.on("connect_error", (err) => {
            setStatus("ERROR");
            log("‚ùå Connection Error: " + err.message);
        });
    }

    function disconnect() {
        if (socket) {
            socket.disconnect();
            setStatus("DISCONNECTED");
            log("Disconnected");
        }
    }

    // LIVE AUCTION LISTENER ----------------------------------------------
    function subscribeLiveAuctions() {
        if (!socket) return log("Connect first!");

        log("Listening for LIVE auction events‚Ä¶");

        // SERVER WILL SEND YOU LIVE AUCTIONS VIA "live_auction" EVENT (YOU BROADCAST THIS IN BACKEND)
        socket.on("live_auction", (data) => {
            log("[LIVE EVENT] " + JSON.stringify(data));

            if (data.type === "LIVE_AUCTION") {
                liveAuctions[data.auctionId] = data;
            }

            if (data.type === "AUCTION_ENDED") {
                delete liveAuctions[data.auctionId];
            }

            updateLiveAuctionUI();
        });
    }

    function updateLiveAuctionUI() {
        const container = document.getElementById("liveAuctionsContainer");

        if (Object.keys(liveAuctions).length === 0) {
            container.innerHTML = "<i>No live auctions right now...</i>";
            return;
        }

        container.innerHTML = Object.values(liveAuctions)
            .map(a => `
                <div class="auction-card">
                    <span class="live">LIVE AUCTION #${a.auctionId}</span><br>
                    Current Price: ‚Çπ${a.currentPrice}<br>
                    Highest Bidder: ${a.highestBidderUserId || "-"}<br>
                    <button onclick="subscribeAuctionId(${a.auctionId})">Subscribe to this Auction</button>
                </div>
            `).join("");
    }

    function subscribeAuctionId(id) {
        document.getElementById("auctionId").value = id;
        subscribeAuction();
    }

    // MANUAL AUCTION SUBSCRIBE ------------------------------------------
    function subscribeAuction() {
        if (!socket) return log("Connect first!");

        const auctionId = Number(document.getElementById("auctionId").value);

        log("Joining auction room: " + auctionId);

        socket.emit("join_auction", auctionId);

        socket.on("bid_update", (msg) => {
            log("[AUCTION BID UPDATE] " + JSON.stringify(msg));
        });
    }

    // SEND BID ------------------------------------------------------------
    function sendBid() {
        if (!socket) return log("Connect first!");

        const auctionId = Number(document.getElementById("auctionId").value);
        const userId = Number(document.getElementById("userId").value);
        const amount = Number(document.getElementById("bidAmount").value);

        const payload = {
            auctionId,
            userId,
            bidAmount: amount
        };

        log("Sending BID ‚Üí " + JSON.stringify(payload));
        socket.emit("new_bid", payload);
    }

    // CHAT ----------------------------------------------------------------
    let isChatListening = false;

    function subscribeChat() {
    if (!socket) return log("Connect first!");

    const reqId = Number(document.getElementById("requestId").value);

    log("Joining chat room " + reqId);
    socket.emit("join_chat", reqId);

    if (!isChatListening) {
        socket.on("chat_update", (msg) => {
            log("[CHAT] " + JSON.stringify(msg));
        });

        socket.on("chat_error", (msg) => {
            log("‚ùå CHAT ERROR: " + msg);
        });

        isChatListening = true;
    }
}


    function sendChat() {
        if (!socket) return log("Connect first!");

        const reqId = Number(document.getElementById("requestId").value);
        const message = document.getElementById("chatMessage").value;
        const userId = buyerId;


        const payload = {
            requestId: reqId,
            userId: userId,
            message: message
        };

        log("Sending CHAT ‚Üí " + JSON.stringify(payload));
        socket.emit("send_chat", payload);
    }

</script>

</body>
</html>
