<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LaptopRequestServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JWT-with-Spring-Security</a> &gt; <a href="index.source.html" class="el_package">com.spring.jwt.laptop.service.impl</a> &gt; <span class="el_source">LaptopRequestServiceImpl.java</span></div><h1>LaptopRequestServiceImpl.java</h1><pre class="source lang-java linenums">package com.spring.jwt.laptop.service.impl;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializationFeature;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import com.spring.jwt.entity.Buyer;
import com.spring.jwt.entity.Seller;
import com.spring.jwt.entity.Status;
import com.spring.jwt.entity.User;
import com.spring.jwt.exception.bookings.LaptopRequestException;
import com.spring.jwt.exception.bookings.LaptopRequestNotFoundException;
import com.spring.jwt.laptop.dto.*;
import com.spring.jwt.laptop.entity.LaptopBooking;
import com.spring.jwt.laptop.model.LaptopRequestStatus;
import com.spring.jwt.laptop.repository.LaptopRepository;
import com.spring.jwt.laptop.repository.LaptopRequestRepository;
import com.spring.jwt.laptop.service.LaptopRequestService;
import com.spring.jwt.repository.BuyerRepository;
import com.spring.jwt.repository.SellerRepository;
import com.spring.jwt.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.OffsetDateTime;
import java.util.ArrayList;
import java.util.List;

@Service
<span class="nc" id="L34">@RequiredArgsConstructor</span>
public class LaptopRequestServiceImpl implements LaptopRequestService {

    private final LaptopRequestRepository requestRepo;
    private final LaptopRepository laptopRepo;
    private final BuyerRepository buyerRepo;
    private final SellerRepository sellerRepo;
    private final UserRepository userRepo;

<span class="nc" id="L43">    private final ObjectMapper objectMapper = new ObjectMapper()</span>
<span class="nc" id="L44">            .registerModule(new JavaTimeModule())</span>
<span class="nc" id="L45">            .disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS);</span>

    @Override
    @Transactional
    public LaptopRequestResponseDTO createRequest(LaptopRequestCreateDTO dto) {
<span class="nc" id="L50">        var laptop = laptopRepo.findByIdAndDeletedFalse(dto.getLaptopId())</span>
<span class="nc" id="L51">                .orElseThrow(() -&gt; new LaptopRequestException(&quot;Laptop not found: &quot; + dto.getLaptopId()));</span>

<span class="nc bnc" id="L53" title="All 4 branches missed.">        if (laptop.getStatus() != null &amp;&amp; laptop.getStatus().name().equalsIgnoreCase(&quot;SOLD&quot;)) {</span>
<span class="nc" id="L54">            throw new LaptopRequestException(&quot;Product already sold.&quot;);</span>
        }

<span class="nc" id="L57">        User buyerUser = userRepo.findById(dto.getBuyerUserId())</span>
<span class="nc" id="L58">                .orElseThrow(() -&gt; new LaptopRequestException(&quot;Buyer (user) not found: &quot; + dto.getBuyerUserId()));</span>

<span class="nc" id="L60">        Buyer buyer = buyerRepo.findByUser_IdAndDeletedFalse(dto.getBuyerUserId())</span>
<span class="nc" id="L61">                .orElseThrow(() -&gt; new LaptopRequestException(&quot;User is not registered as a buyer: &quot; + dto.getBuyerUserId()));</span>

<span class="nc" id="L63">        Seller seller = laptop.getSeller();</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">        if (seller == null) throw new LaptopRequestException(&quot;Laptop has no seller assigned&quot;);</span>

<span class="nc" id="L66">        boolean alreadyRequested = requestRepo.findByBuyer_BuyerId(buyer.getBuyerId())</span>
<span class="nc" id="L67">                .stream().anyMatch(r -&gt; r.getLaptop().getId().equals(laptop.getId()));</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">        if (alreadyRequested) {</span>
<span class="nc" id="L69">            throw new LaptopRequestException(&quot;You have already sent a request for this product.&quot;);</span>
        }

<span class="nc bnc" id="L72" title="All 4 branches missed.">        if (dto.getBookingDate() == null || dto.getBookingDate().isBefore(LocalDate.now())) {</span>
<span class="nc" id="L73">            throw new LaptopRequestException(&quot;Booking date must be today or in the future.&quot;);</span>
        }



<span class="nc" id="L78">        LaptopBooking r = LaptopBooking.builder()</span>
<span class="nc" id="L79">                .laptop(laptop)</span>
<span class="nc" id="L80">                .buyer(buyer)</span>
<span class="nc" id="L81">                .seller(seller)</span>
<span class="nc" id="L82">                .onDate(dto.getBookingDate())</span>
<span class="nc" id="L83">                .pendingStatus(LaptopRequestStatus.PENDING)</span>
<span class="nc" id="L84">                .requestConversation(&quot;[]&quot;)</span>
<span class="nc" id="L85">                .build();</span>

<span class="nc bnc" id="L87" title="All 4 branches missed.">        if (dto.getMessage() != null &amp;&amp; !dto.getMessage().isBlank()) {</span>
<span class="nc" id="L88">            appendMessageInternal(r, buyerUser.getId(), &quot;BUYER&quot;, dto.getMessage());</span>
        }

        try {
<span class="nc" id="L92">            r = requestRepo.save(r);</span>
<span class="nc" id="L93">        } catch (DataIntegrityViolationException e) {</span>
<span class="nc" id="L94">            throw new LaptopRequestException(&quot;Failed to create request: &quot; + e.getMessage());</span>
<span class="nc" id="L95">        }</span>

<span class="nc" id="L97">        return toResponse(r);</span>
    }

    @Override
    public List&lt;LaptopRequestResponseDTO&gt; listRequestsForLaptop(Long laptopId) {
<span class="nc" id="L102">        laptopRepo.findById(laptopId)</span>
<span class="nc" id="L103">                .orElseThrow(() -&gt; new LaptopRequestException(&quot;Laptop with ID &quot; + laptopId + &quot; not found.&quot;));</span>

<span class="nc" id="L105">        List&lt;LaptopBooking&gt; requests = requestRepo.findByLaptop_IdOrderByCreatedAtAsc(laptopId);</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (requests.isEmpty()) {</span>
<span class="nc" id="L108">            throw new LaptopRequestException(&quot;No requests found for laptop ID &quot; + laptopId + &quot;.&quot;);</span>
        }

<span class="nc" id="L111">        return requests.stream().map(this::toResponse).toList();</span>
    }

    @Override
    public List&lt;LaptopRequestResponseDTO&gt; listRequestsForBuyer(Long buyerId) {
<span class="nc" id="L116">        buyerRepo.findById(buyerId)</span>
<span class="nc" id="L117">                .orElseThrow(() -&gt; new LaptopRequestException(&quot;Buyer with ID &quot; + buyerId + &quot; not found.&quot;));</span>

<span class="nc" id="L119">        List&lt;LaptopBooking&gt; requests = requestRepo.findByBuyer_BuyerId(buyerId);</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (requests.isEmpty()) {</span>
<span class="nc" id="L122">            throw new LaptopRequestException(&quot;No requests found for buyer ID &quot; + buyerId + &quot;.&quot;);</span>
        }

<span class="nc" id="L125">        return requests.stream().map(this::toResponse).toList();</span>
    }

    @Override
    @Transactional
    public LaptopRequestResponseDTO updateRequestStatus(Long requestId, String statusStr) {
<span class="nc" id="L131">        LaptopBooking req = requestRepo.findById(requestId)</span>
<span class="nc" id="L132">                .orElseThrow(() -&gt; new LaptopRequestNotFoundException(requestId));</span>

        LaptopRequestStatus newStatus;
        try {
<span class="nc" id="L136">            newStatus = LaptopRequestStatus.valueOf(statusStr.toUpperCase());</span>
<span class="nc" id="L137">        } catch (IllegalArgumentException ex) {</span>
<span class="nc" id="L138">            throw new LaptopRequestException(&quot;Invalid status: &quot; + statusStr);</span>
<span class="nc" id="L139">        }</span>

<span class="nc" id="L141">        synchronized ((&quot;laptop-lock-&quot; + req.getLaptop().getId()).intern()) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            if (newStatus == LaptopRequestStatus.ACCEPTED) {</span>
<span class="nc" id="L143">                boolean exists = requestRepo.existsByLaptop_IdAndPendingStatus(req.getLaptop().getId(), LaptopRequestStatus.ACCEPTED);</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">                if (exists) throw new LaptopRequestException(&quot;Another request already ACCEPTED for this laptop.&quot;);</span>

<span class="nc" id="L146">                req.setPendingStatus(LaptopRequestStatus.ACCEPTED);</span>

<span class="nc" id="L148">                req.getLaptop().setStatus(Status.ACTIVE);</span>
<span class="nc" id="L149">                laptopRepo.save(req.getLaptop());</span>

<span class="nc bnc" id="L151" title="All 2 branches missed.">            } else if (newStatus == LaptopRequestStatus.REJECTED) {</span>
<span class="nc" id="L152">                boolean exists = requestRepo.existsByLaptop_IdAndPendingStatus(req.getLaptop().getId(), LaptopRequestStatus.REJECTED);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">                if (exists) throw new LaptopRequestException(&quot;Request already REJECTED for this laptop.&quot;);</span>
<span class="nc" id="L154">                req.setPendingStatus(LaptopRequestStatus.REJECTED);</span>

<span class="nc" id="L156">                boolean anyAccepted = requestRepo.existsByLaptop_IdAndPendingStatus(req.getLaptop().getId(), LaptopRequestStatus.ACCEPTED);</span>
<span class="nc bnc" id="L157" title="All 4 branches missed.">                if (!anyAccepted &amp;&amp; req.getLaptop().getStatus() != Status.SOLD) {</span>
<span class="nc" id="L158">                    req.getLaptop().setStatus(Status.ACTIVE);</span>
<span class="nc" id="L159">                    laptopRepo.save(req.getLaptop());</span>
                }

<span class="nc bnc" id="L162" title="All 2 branches missed.">            } else if (newStatus == LaptopRequestStatus.COMPLETED) {</span>
<span class="nc" id="L163">                boolean exists = requestRepo.existsByLaptop_IdAndPendingStatus(req.getLaptop().getId(), LaptopRequestStatus.COMPLETED);</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                if (exists) throw new LaptopRequestException(&quot;Request already COMPLETED for this laptop.&quot;);</span>

<span class="nc" id="L166">                req.setPendingStatus(LaptopRequestStatus.COMPLETED);</span>
<span class="nc" id="L167">                req.getLaptop().setStatus(Status.SOLD);</span>
<span class="nc" id="L168">                laptopRepo.save(req.getLaptop(</span>


                ));
<span class="nc" id="L172">                var others = requestRepo.findByLaptop_IdAndPendingStatus(req.getLaptop().getId(), LaptopRequestStatus.PENDING);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                for (var o : others) {</span>
<span class="nc" id="L174">                    o.setPendingStatus(LaptopRequestStatus.REJECTED);</span>
<span class="nc" id="L175">                    requestRepo.save(o);</span>
<span class="nc" id="L176">                }</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">            } else if(newStatus == LaptopRequestStatus.IN_NEGOTIATION){</span>
<span class="nc" id="L179">                boolean exists = requestRepo.existsByLaptop_IdAndPendingStatus(req.getLaptop().getId(), LaptopRequestStatus.IN_NEGOTIATION);</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">                if (exists) throw new LaptopRequestException(&quot;Laptop is already is in IN_NEGOTIATION.&quot;);</span>

<span class="nc" id="L182">                req.setPendingStatus(LaptopRequestStatus.IN_NEGOTIATION);</span>
<span class="nc" id="L183">                req.getLaptop().setStatus(Status.ACTIVE);</span>
<span class="nc" id="L184">                laptopRepo.save(req.getLaptop());</span>

<span class="nc" id="L186">            }</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">            else if(newStatus == LaptopRequestStatus.PENDING){</span>
<span class="nc" id="L188">                boolean exists = requestRepo.existsByLaptop_IdAndPendingStatus(req.getLaptop().getId(), LaptopRequestStatus.PENDING);</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                if (exists) throw new LaptopRequestException(&quot;Laptop request is already PENDING.&quot;);</span>

<span class="nc" id="L191">                req.setPendingStatus(LaptopRequestStatus.PENDING);</span>
<span class="nc" id="L192">                req.getLaptop().setStatus(Status.ACTIVE);</span>
<span class="nc" id="L193">                laptopRepo.save(req.getLaptop());</span>
<span class="nc" id="L194">            }</span>
            else {
<span class="nc" id="L196">                req.setPendingStatus(newStatus);</span>
            }

<span class="nc" id="L199">            requestRepo.save(req);</span>
<span class="nc" id="L200">        }</span>

<span class="nc" id="L202">        return toResponse(req);</span>
        }


    @Override
    @Transactional
    public LaptopRequestResponseDTO appendMessage(Long requestId, Long senderUserId, String message) {
<span class="nc" id="L209">        LaptopBooking req = requestRepo.findById(requestId)</span>
<span class="nc" id="L210">                .orElseThrow(() -&gt; new LaptopRequestNotFoundException(requestId));</span>

<span class="nc" id="L212">        User sender = userRepo.findById(senderUserId)</span>
<span class="nc" id="L213">                .orElseThrow(() -&gt; new LaptopRequestException(&quot;Sender user not found: &quot; + senderUserId));</span>

<span class="nc" id="L215">        String senderType = determineSenderType(senderUserId, req);</span>
<span class="nc" id="L216">        appendMessageInternal(req, senderUserId, senderType, message);</span>
<span class="nc" id="L217">        requestRepo.save(req);</span>
<span class="nc" id="L218">        return toResponse(req);</span>
    }

    @Override
    @Transactional
    public void markRequestCompletedAndMarkSold(Long requestId) {
<span class="nc" id="L224">        LaptopBooking req = requestRepo.findById(requestId)</span>
<span class="nc" id="L225">                .orElseThrow(() -&gt; new LaptopRequestNotFoundException(requestId));</span>

<span class="nc" id="L227">        synchronized ((&quot;laptop-lock-&quot; + req.getLaptop().getId()).intern()) {</span>
<span class="nc bnc" id="L228" title="All 4 branches missed.">            if (req.getPendingStatus() != LaptopRequestStatus.ACCEPTED &amp;&amp; req.getPendingStatus() != LaptopRequestStatus.IN_NEGOTIATION) {</span>
<span class="nc" id="L229">                throw new LaptopRequestException(&quot;Request must be ACCEPTED or IN_NEGOTIATION to mark completed.&quot;);</span>
            }
<span class="nc" id="L231">            req.setPendingStatus(LaptopRequestStatus.COMPLETED);</span>
<span class="nc" id="L232">            req.getLaptop().setStatus(Status.SOLD);</span>
<span class="nc" id="L233">            laptopRepo.save(req.getLaptop());</span>
<span class="nc" id="L234">            var others = requestRepo.findByLaptop_IdAndPendingStatus(req.getLaptop().getId(), LaptopRequestStatus.PENDING);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">            for (var o : others) {</span>
<span class="nc" id="L236">                o.setPendingStatus(LaptopRequestStatus.REJECTED);</span>
<span class="nc" id="L237">                requestRepo.save(o);</span>
<span class="nc" id="L238">            }</span>
<span class="nc" id="L239">            requestRepo.save(req);</span>
<span class="nc" id="L240">        }</span>
<span class="nc" id="L241">    }</span>

    private void appendMessageInternal(LaptopBooking req, Long senderId, String senderType, String text) {
        try {
<span class="nc" id="L245">            List&lt;ConversationMessageDTO&gt; msgs = objectMapper.readValue(</span>
<span class="nc" id="L246">                    req.getRequestConversation(), new TypeReference&lt;List&lt;ConversationMessageDTO&gt;&gt;() {</span>
                    });
<span class="nc bnc" id="L248" title="All 2 branches missed.">            if (msgs == null) msgs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L249">            msgs.add(new ConversationMessageDTO(senderId, senderType, text, OffsetDateTime.now()));</span>
<span class="nc" id="L250">            req.setRequestConversation(objectMapper.writeValueAsString(msgs));</span>
<span class="nc" id="L251">        } catch (Exception e) {</span>
<span class="nc" id="L252">            throw new LaptopRequestException(&quot;Failed to append message&quot;);</span>
<span class="nc" id="L253">        }</span>
<span class="nc" id="L254">    }</span>

    private String determineSenderType(Long userId, LaptopBooking req) {
<span class="nc bnc" id="L257" title="All 4 branches missed.">        if (req.getBuyer() != null &amp;&amp; req.getBuyer().getUser() != null &amp;&amp;</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">                req.getBuyer().getUser().getId().equals(userId)) return &quot;BUYER&quot;;</span>
<span class="nc bnc" id="L259" title="All 4 branches missed.">        if (req.getSeller() != null &amp;&amp; req.getSeller().getUser() != null &amp;&amp;</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">                req.getSeller().getUser().getId().equals(userId)) return &quot;SELLER&quot;;</span>
<span class="nc" id="L261">        return &quot;UNKNOWN&quot;;</span>
    }

    private LaptopRequestResponseDTO toResponse(LaptopBooking r) {
<span class="nc" id="L265">        return LaptopRequestResponseDTO.builder()</span>
<span class="nc" id="L266">                .laptopBookingId(r.getLaptopBookingId())</span>
<span class="nc" id="L267">                .laptopId(r.getLaptop().getId())</span>
<span class="nc" id="L268">                .buyerId(r.getBuyer().getBuyerId())</span>
<span class="nc" id="L269">                .sellerId(r.getSeller().getSellerId())</span>
<span class="nc" id="L270">                .status(r.getPendingStatus().name())</span>
<span class="nc" id="L271">                .conversationJson(r.getRequestConversation())</span>
<span class="nc" id="L272">                .createdAt(r.getCreatedAt())</span>
<span class="nc" id="L273">                .bookingDate(r.getOnDate())</span>
<span class="nc" id="L274">                .build();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>