<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LaptopServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JWT-with-Spring-Security</a> &gt; <a href="index.source.html" class="el_package">com.spring.jwt.laptop.service.impl</a> &gt; <span class="el_source">LaptopServiceImpl.java</span></div><h1>LaptopServiceImpl.java</h1><pre class="source lang-java linenums">package com.spring.jwt.laptop.service.impl;

import com.spring.jwt.entity.Seller;
import com.spring.jwt.entity.Status;
import com.spring.jwt.exception.laptop.BlankFieldsException;
import com.spring.jwt.exception.laptop.LaptopAlreadyExistsException;
import com.spring.jwt.exception.laptop.LaptopNotFoundException;
import com.spring.jwt.exception.mobile.SellerNotFoundException;
import com.spring.jwt.laptop.dto.LaptopRequestDTO;
import com.spring.jwt.laptop.entity.Laptop;
import com.spring.jwt.laptop.repository.LaptopRepository;
import com.spring.jwt.repository.SellerRepository;
import com.spring.jwt.laptop.service.LaptopService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.Arrays;
import java.util.List;

<span class="nc" id="L28">@Slf4j</span>
@Service
<span class="nc" id="L30">@RequiredArgsConstructor</span>
public class LaptopServiceImpl implements LaptopService {

    private final LaptopRepository laptopRepository;
    private final SellerRepository sellerRepository;

    public Laptop create(LaptopRequestDTO requestDTO) {

<span class="nc" id="L38">        Seller seller = sellerRepository.findById(requestDTO.getSellerId())</span>
<span class="nc" id="L39">                .orElseThrow(() -&gt; new SellerNotFoundException(requestDTO.getSellerId()));</span>

<span class="nc bnc" id="L41" title="All 2 branches missed.">        if(laptopRepository.existsBySerialNumber(requestDTO.getSerialNumber())){</span>
<span class="nc" id="L42">            throw new LaptopAlreadyExistsException(&quot;Laptop already exists with serial number &quot; + requestDTO.getSerialNumber());</span>
        }

<span class="nc" id="L45">        Laptop laptop = new Laptop();</span>
<span class="nc" id="L46">        laptop.setSerialNumber(requestDTO.getSerialNumber());</span>
<span class="nc" id="L47">        laptop.setDealer(requestDTO.getDealer());</span>
<span class="nc" id="L48">        laptop.setModel(requestDTO.getModel());</span>
<span class="nc" id="L49">        laptop.setBrand(requestDTO.getBrand());</span>
<span class="nc" id="L50">        laptop.setPrice(requestDTO.getPrice());</span>
<span class="nc" id="L51">        laptop.setWarrantyInYear(requestDTO.getWarrantyInYear());</span>
<span class="nc" id="L52">        laptop.setProcessor(requestDTO.getProcessor());</span>
<span class="nc" id="L53">        laptop.setStatus(requestDTO.getStatus());</span>
<span class="nc" id="L54">        laptop.setBattery(requestDTO.getBattery());</span>
<span class="nc" id="L55">        laptop.setBatteryLife(requestDTO.getBatteryLife());</span>
<span class="nc" id="L56">        laptop.setColour(requestDTO.getColour());</span>
<span class="nc" id="L57">        laptop.setGraphicBrand(requestDTO.getGraphicBrand());</span>
<span class="nc" id="L58">        laptop.setGraphicsCard(requestDTO.getGraphicsCard());</span>
<span class="nc" id="L59">        laptop.setManufacturer(requestDTO.getManufacturer());</span>
<span class="nc" id="L60">        laptop.setMemoryType(requestDTO.getMemoryType());</span>
<span class="nc" id="L61">        laptop.setProcessorBrand(requestDTO.getProcessorBrand());</span>
<span class="nc" id="L62">        laptop.setRam(requestDTO.getRam());</span>
<span class="nc" id="L63">        laptop.setScreenSize(requestDTO.getScreenSize());</span>
<span class="nc" id="L64">        laptop.setStorage(requestDTO.getStorage());</span>
<span class="nc" id="L65">        laptop.setUsbPorts(requestDTO.getUsbPorts());</span>
<span class="nc" id="L66">        laptop.setWeight(requestDTO.getWeight());</span>
<span class="nc" id="L67">        laptop.setSeller(seller);</span>

<span class="nc" id="L69">        return laptopRepository.save(laptop);</span>
    }



    private void validateBlankFields(LaptopRequestDTO laptopRequestDTO) {
<span class="nc" id="L75">        Arrays.stream(laptopRequestDTO.getClass().getDeclaredFields())</span>
<span class="nc" id="L76">                .filter(field -&gt; field.getType().equals(String.class)) // only check string fields</span>
<span class="nc" id="L77">                .forEach(field -&gt; {</span>
<span class="nc" id="L78">                    field.setAccessible(true);</span>
                    try {
<span class="nc" id="L80">                        Object value = field.get(laptopRequestDTO);</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">                        if (value != null &amp;&amp; ((String) value).isBlank()) {</span>
<span class="nc" id="L82">                            throw new BlankFieldsException(field.getName() + &quot; cannot be blank&quot;);</span>
                        }
<span class="nc" id="L84">                    } catch (IllegalAccessException e) {</span>
<span class="nc" id="L85">                        throw new RuntimeException(&quot;Error accessing field: &quot; + field.getName(), e);</span>
<span class="nc" id="L86">                    }</span>
<span class="nc" id="L87">                });</span>
<span class="nc" id="L88">    }</span>


    @Transactional
    public Laptop update(Long laptopId, LaptopRequestDTO laptopRequestDTO) {

<span class="nc" id="L94">        validateBlankFields(laptopRequestDTO);</span>

<span class="nc" id="L96">        Laptop laptop = laptopRepository.findById(laptopId)</span>
<span class="nc" id="L97">                .orElseThrow(() -&gt; new LaptopNotFoundException(&quot;Laptop not found with ID &quot; + laptopId));</span>

        // Only update fields if they are not null
<span class="nc bnc" id="L100" title="All 4 branches missed.">        if (laptopRequestDTO.getSerialNumber() != null &amp;&amp; !laptopRequestDTO.getSerialNumber().equals(laptop.getSerialNumber())) {</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">            if (laptopRepository.existsBySerialNumber(laptopRequestDTO.getSerialNumber())) {</span>
<span class="nc" id="L102">                throw new LaptopAlreadyExistsException(&quot;Laptop with serial number &quot; + laptopRequestDTO.getSerialNumber() + &quot; already exists&quot;);</span>
            }
<span class="nc" id="L104">            laptop.setSerialNumber(laptopRequestDTO.getSerialNumber());</span>
        }
<span class="nc bnc" id="L106" title="All 2 branches missed.">        if (laptopRequestDTO.getDealer() != null) laptop.setDealer(laptopRequestDTO.getDealer());</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (laptopRequestDTO.getModel() != null) laptop.setModel(laptopRequestDTO.getModel());</span>

<span class="nc bnc" id="L109" title="All 2 branches missed.">        if (laptopRequestDTO.getBrand() != null) laptop.setBrand(laptopRequestDTO.getBrand());</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (laptopRequestDTO.getPrice() != null) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">            if (laptopRequestDTO.getPrice() &lt; 0) {</span>
<span class="nc" id="L113">                throw new IllegalArgumentException(&quot;Price must be non-negative&quot;);</span>
            }
<span class="nc" id="L115">            laptop.setPrice(laptopRequestDTO.getPrice());</span>
        }

<span class="nc bnc" id="L118" title="All 2 branches missed.">        if (laptopRequestDTO.getWarrantyInYear() != null) laptop.setWarrantyInYear(laptopRequestDTO.getWarrantyInYear());</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (laptopRequestDTO.getProcessor() != null) laptop.setProcessor(laptopRequestDTO.getProcessor());</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (laptopRequestDTO.getProcessorBrand() != null) laptop.setProcessorBrand(laptopRequestDTO.getProcessorBrand());</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (laptopRequestDTO.getMemoryType() != null) laptop.setMemoryType(laptopRequestDTO.getMemoryType());</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">        if (laptopRequestDTO.getScreenSize() != null) laptop.setScreenSize(laptopRequestDTO.getScreenSize());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (laptopRequestDTO.getColour() != null) laptop.setColour(laptopRequestDTO.getColour());</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if(laptopRequestDTO.getRam() != null) laptop.setRam(laptopRequestDTO.getRam());</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        if (laptopRequestDTO.getStorage() != null) laptop.setStorage(laptopRequestDTO.getStorage());</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (laptopRequestDTO.getBattery() != null) laptop.setBattery(laptopRequestDTO.getBattery());</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (laptopRequestDTO.getBatteryLife() != null) laptop.setBatteryLife(laptopRequestDTO.getBatteryLife());</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (laptopRequestDTO.getGraphicsCard() != null) laptop.setGraphicsCard(laptopRequestDTO.getGraphicsCard());</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">        if (laptopRequestDTO.getGraphicBrand() != null) laptop.setGraphicBrand(laptopRequestDTO.getGraphicBrand());</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">        if (laptopRequestDTO.getWeight() != null) laptop.setWeight(laptopRequestDTO.getWeight());</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (laptopRequestDTO.getManufacturer() != null) laptop.setManufacturer(laptopRequestDTO.getManufacturer());</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (laptopRequestDTO.getUsbPorts() != null) laptop.setUsbPorts(laptopRequestDTO.getUsbPorts());</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (laptopRequestDTO.getStatus() != null) laptop.setStatus(laptopRequestDTO.getStatus());</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">        if (laptopRequestDTO.getSellerId() != null) {</span>
<span class="nc" id="L136">            Seller seller = sellerRepository.findById(laptopRequestDTO.getSellerId())</span>
<span class="nc" id="L137">                    .orElseThrow(() -&gt; new SellerNotFoundException(laptopRequestDTO.getSellerId()));</span>
<span class="nc" id="L138">            laptop.setSeller(seller);</span>
        }

<span class="nc" id="L141">        return laptopRepository.save(laptop);</span>
    }


    public Laptop getById(Long laptopId) {
<span class="nc" id="L146">        return laptopRepository.findById(laptopId)</span>
<span class="nc" id="L147">                .orElseThrow(() -&gt; new LaptopNotFoundException(&quot;Laptop with ID &quot; + laptopId + &quot; not found&quot;));</span>
    }

    public List&lt;Laptop&gt; getAllLaptops() {

<span class="nc" id="L152">        return laptopRepository.findAll();</span>
    }


    @Override
    @Transactional
    public String deleteLaptopById(Long laptopId) {
<span class="nc" id="L159">        Laptop laptop = laptopRepository.findById(laptopId)</span>
<span class="nc" id="L160">                .orElseThrow(() -&gt; new LaptopNotFoundException(&quot;Laptop not found with id: &quot; + laptopId));</span>

<span class="nc" id="L162">        LocalDateTime now = LocalDateTime.now(ZoneId.of(&quot;Asia/Kolkata&quot;));</span>
<span class="nc" id="L163">        log.debug(&quot;Processing delete for Laptop with ID {} at {}&quot;, laptopId, now);</span>

        // === HARD DELETE (if already soft deleted) ===
<span class="nc bnc" id="L166" title="All 4 branches missed.">        if (laptop.isDeleted() || laptop.getStatus() == Status.DELETE) {</span>

<span class="nc bnc" id="L168" title="All 4 branches missed.">            if (laptop.getBookings() != null &amp;&amp; !laptop.getBookings().isEmpty()) {</span>
<span class="nc" id="L169">                laptop.getBookings().clear();</span>
            }

<span class="nc bnc" id="L172" title="All 4 branches missed.">            if (laptop.getLaptopPhotos() != null &amp;&amp; !laptop.getLaptopPhotos().isEmpty()) {</span>
<span class="nc" id="L173">                laptop.getLaptopPhotos().clear();</span>
            }

            // Now safe to hard delete
<span class="nc" id="L177">            laptopRepository.delete(laptop);</span>
<span class="nc" id="L178">            log.info(&quot;Hard deleted Laptop with ID {}&quot;, laptopId);</span>
<span class="nc" id="L179">            return &quot;Laptop with ID &quot; + laptopId + &quot; was permanently deleted from database.&quot;;</span>
        }

        // === SOFT DELETE (first delete call) ===
<span class="nc" id="L183">        laptop.setDeleted(true);</span>
<span class="nc" id="L184">        laptop.setDeletedAt(now);</span>
<span class="nc" id="L185">        laptop.setStatus(Status.DELETE);</span>

<span class="nc" id="L187">        laptopRepository.save(laptop);</span>
<span class="nc" id="L188">        log.info(&quot;Soft deleted Laptop with ID {} at {}&quot;, laptopId, now);</span>

<span class="nc" id="L190">        return &quot;Soft deleted Laptop with ID &quot; + laptopId + &quot; at &quot; + now;</span>
    }



    @Override
    public Page&lt;Laptop&gt; getBySellerIdAndStatus(Long sellerId, Status status, int page, int size, String sortBy) {
<span class="nc" id="L197">        sellerRepository.findById(sellerId)</span>
<span class="nc" id="L198">                .orElseThrow(() -&gt; new SellerNotFoundException(sellerId));</span>

<span class="nc" id="L200">        Pageable pageable = PageRequest.of(page,size, Sort.by(sortBy).ascending());</span>
<span class="nc" id="L201">        return laptopRepository.findBySellerIdAndStatus(sellerId,status,pageable);</span>
    }

    @Override
    public Page&lt;Laptop&gt; getByStatus(Status status, int page, int size, String sortBy) {
<span class="nc" id="L206">        Pageable pageable = PageRequest.of(page,size,Sort.by(sortBy).ascending());</span>
<span class="nc" id="L207">        return laptopRepository.findByStatus(status, pageable);</span>
    }


    @Override
    public Long countBySellerIdAndStatus(Long sellerId, Status status) {
<span class="nc" id="L213">        sellerRepository.findById(sellerId)</span>
<span class="nc" id="L214">                .orElseThrow(() -&gt; new SellerNotFoundException(sellerId));</span>

<span class="nc" id="L216">        return laptopRepository.countBySellerAndStatus(sellerId,status);</span>
    }

    @Override
    public Page&lt;Laptop&gt; getAllBySellerId(Long sellerId, int page, int size, String sortBy) {
<span class="nc" id="L221">        Pageable pageable = PageRequest.of(page, size, Sort.by(sortBy).descending());</span>
<span class="nc" id="L222">        return laptopRepository.findBySeller_SellerId(sellerId, pageable);</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>